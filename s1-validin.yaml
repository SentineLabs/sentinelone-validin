name: s1-validin
version: 3.1.1

synapse_version: '>=2.144.0,<3.0.0'

genopts:
    dotstorm: true 

author:
  url: https://github.com/SentineLabs/s1-validin
  name: SentinelLABS <labs@sentinelone.com>

desc: s1-validin is a rapid power-up for Validin.

docs:
  - title: Changelog
    path: docs/changelog.md
  - title: Admin Guide
    path: docs/admin_guide.md
  - title: User Guide  
    path: docs/user_guide.md
  - title: Package Documentation
    path: docs/package_documentation.md

onload: $lib.import(s1.validin.model).update_forms()

perms:
  - perm: [s1, validin, admin]
    gate: cortex
    desc: Allows a user to set global configuration values for s1-validin.
  - perm: [s1, validin, user]
    gate: cortex
    desc: Allows a user to call privileged APIs from s1-validin.

modules:
  - name: s1.validin
  - name: s1.validin.api
  - name: s1.validin.download
  - name: s1.validin.ingest
  - name: s1.validin.ingest.crawlr
  - name: s1.validin.ingest.ctstream
  - name: s1.validin.ingest.dns
  - name: s1.validin.ingest.pivot
  - name: s1.validin.ingest.registration
  - name: s1.validin.model
  - name: s1.validin.privsep
    asroot:perms:
      - [s1, validin, user]
  - name: s1.validin.privsep.admin
    asroot:perms:
      - [s1, validin, admin]

commands:
  - name: s1.validin.certs
    descr: |
      Get domain certificates seen in the Certificate Transparency Stream.

      This command accepts the following input node forms:
        - inet:fqdn

      // get all certificates for an inet:fqdn node
      inet:fqdn=sentinelone.com | s1.validin.certs

    cmdargs:
      # - - --download
      #   - type: bool
      #     action: store_true
      #     help: Download certificate bytes.
      - - --first-seen
        - type: time
          help: Filter to certificates seen on or after this time.
      - - --last-seen
        - type: time
          help: Filter to certificates seen before this time.
      - - --wildcard
        - type: bool
          action: store_true
          help: Include certificates for subdomains.
      - - --limit
        - type: int
          default: 20000
          help: Limit number of certificates up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

  - name: s1.validin.dns
    descr: |
      Get DNS records.

      This command accepts the following input node forms:
        - inet:fqdn
        - inet:ipv4
        - inet:ipv6

      // get all dns records for an inet:fqdn node
      inet:fqdn=sentinelone.com | s1.validin.dns

      // get all dns records for an inet:fqdn node, including subdomains
      inet:fqdn=sentinelone.com | s1.validin.dns --wildcard

      // get all dns records for multiple inet:ipv4 nodes
      inet:ipv4#cno.threat.t4.use | s1.validin.dns

      // get dns records from 2024 for an inet:fqdn node
      inet:fqdn=sentinelone.com | s1.validin.dns --first-seen 2024 --last-seen 2024/12/31

    cmdargs:
      - - --first-seen
        - type: time
          help: Filter records seen on or after this time.
      - - --last-seen
        - type: time
          help: Filter records seen before this time.
      - - --wildcard
        - type: bool
          action: store_true
          help: Include records for subdomains.
      - - --limit
        - type: int
          default: 20000
          help: Limit number of records up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

  - name: s1.validin.download
    descr: |
      Download raw bytes for HTTP bodies, certificates, and favicons.

      This command accepts the following input node forms:
        - crypto:x509:cert
        - inet:http:request

      // download a certificate for a crypto:x509:cert node
      crypto:x509:cert=<xyz> | s1.validin.download

    cmdargs:
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

  - name: s1.validin.enrich
    descr: |
      Enrich an FQDN with DNS, HTTP crawler, and WHOIS data.

      This command accepts the following input node forms:
        - inet:fqdn

      // enrich an inet:fqdn node with dns, http, and whois data
      inet:fqdn=sentinelone.com | s1.validin.enrich

    cmdargs:
      - - --download
        - type: bool
          action: store_true
          help: Download raw HTTP data including response bodies, certificates, and favicons.
      - - --first-seen
        - type: time
          help: Filter data seen on or after this time.
      - - --last-seen
        - type: time
          help: Filter data seen before this time.
      - - --wildcard
        - type: bool
          action: store_true
          help: Include data for subdomains.
      - - --limit
        - type: int
          default: 20000
          help: Limit number of results up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

  - name: s1.validin.http
    descr: |
      Get HTTP crawl history.

      This command accepts the following input node forms:
        - inet:fqdn
        - inet:ipv4
        - inet:ipv6

    cmdargs:
      - - --download
        - type: bool
          action: store_true
          help: Download HTTP bodies and favicons.
      - - --first-seen
        - type: time
          help: Filter requests made on or after this time.
      - - --last-seen
        - type: time
          help: Filter requests made before this time.
      - - --wildcard
        - type: bool
          action: store_true
          help: Include requests for subdomains.
      - - --limit
        - type: int
          default: 20000
          help: Limit number of requests up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

  - name: s1.validin.http.pivot
    descr: |
      Pivot from HTTP content or a hash to related artifacts.

      This command accepts the following input node forms:
        - inet:http:request
        - hash:md5
        - hash:sha1
        - hash:sha256

      // pivot from an inet:http:request node
      inet:http:request=<guid> | s1.validin.http.pivot

      // pivot from a hash node
      hash:md5=<value> | s1.validin.http.pivot

    cmdargs:
      - - --category
        - type: str
          choices:
            - BANNER_0_HASH
            - BODY_SHA1
            - CERT_FINGERPRINT
            - CERT_FINGERPRINT_SHA256
            - CLASS_0_HASH
            - CLASS_1_HASH
            - FAVICON_HASH
            - HEADER_HASH
          help: Optional pivot category filter.
      - - --first-seen 
        - type: time
          help: Filter records seen on or after this time.
      - - --last-seen
        - type: time
          help: Filter records seen before this time.
      - - --limit
        - type: int
          default: 20000
          help: Limit number of records up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.
      - - --dry-run
        - type: bool
          action: store_true
          help: Do not create nodes, only print them.

  - name: s1.validin.setup.apikey
    descr: Set the Validin API key to use.
    perms:
      - [s1, validin, user]
    cmdargs:
      - - apikey
        - type: str
          help: The API Key
      - - --global
        - type: bool
          default: false
          action: store_true
          help: Set the API key globally for all users.
  
  - name: s1.validin.setup.hostname
    descr: Set the Validin API hostname to use globally. Default is "pilot.validin.com".
    perms:
      - [s1, validin, admin]
    cmdargs:
      - - hostname
        - type: str
          default: pilot.validin.com
          help: The hostname to use.
 
  - name: s1.validin.whois
    descr: |
      Get WHOIS records.

      This command accepts the following input node forms:
        - inet:fqdn

      // get all whois records for an inet:fqdn node
      inet:fqdn=sentinelone.com | s1.validin.whois

    cmdargs:
      - - --first-seen
        - type: time
          help: Filter records seen on or after this time.
      - - --last-seen
        - type: time
          help: Filter records seen before this time.
      - - --wildcard
        - type: bool
          action: store_true
          help: Include records for subdomains
      - - --limit
        - type: int
          default: 20000
          help: Limit number of records up to 20000.
      - - --yield
        - type: bool
          action: store_true
          help: Yield created nodes.

optic:
  actions:
    - name: certs
      storm: s1.validin.certs
      descr: Get certificates for a domain.
      forms: [inet:fqdn]
    - name: certs wild
      storm: s1.validin.certs --wildcard
      descr: Get certificates for a domain including subdomains.
      forms: [inet:fqdn]
    - name: dns
      storm: s1.validin.dns
      descr: Get DNS records.
      forms: [inet:fqdn, inet:ipv4, inet:ipv6]
    - name: dns wild
      storm: s1.validin.dns --wildcard
      descr: Get DNS records including subdomains.
      forms: [inet:fqdn]
    - name: download and parse
      storm: s1.validin.download --yield | fileparser.parse
      descr: Download HTTP bodies, certificates, and favicons, then parse.
      forms: [crypto:x509:cert, inet:http:request]
    - name: enrich
      storm: s1.validin.enrich
      descr: Enrich with DNS, crawler, and WHOIS records.
      forms: [inet:fqdn]
    - name: http
      storm: s1.validin.http
      descr: Get HTTP crawling history.
      forms: [inet:fqdn, inet:ipv4, inet:ipv6]
    - name: http pivot
      storm: s1.validin.http.pivot
      descr: Pivot from HTTP content or a hash to related artifacts.
      forms: [inet:http:request, hash:md5, hash:sha1, hash:sha256]
    - name: whois
      storm: s1.validin.whois
      descr: Get WHOIS records for a domain.
      forms: [inet:fqdn]
    - name: whois wild
      storm: s1.validin.whois --wildcard
      descr: Get WHOIS records for a domain including subdomains.
      forms: [inet:fqdn]
